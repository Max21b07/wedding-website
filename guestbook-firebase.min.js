class FirebaseGuestbook{constructor(){this.form=document.getElementById("guestbookForm"),this.messagesContainer=document.getElementById("guestbookMessages"),this.emptyState=document.getElementById("guestbookEmpty"),this.toggleBtn=document.getElementById("showPrivateToggle"),this.showPrivate=!1,this.db=window.db,this.init()}init(){if(!this.db)return console.error("Firebase not initialized"),void this.fallbackToLocalStorage();this.form.addEventListener("submit",e=>this.handleSubmit(e)),this.toggleBtn&&this.toggleBtn.addEventListener("click",()=>this.togglePrivateMessages()),this.listenForMessages(),this.addDemoMessagesIfEmpty()}async addDemoMessagesIfEmpty(){try{if((await this.db.collection("guestbook").limit(1).get()).empty){const e=[{name:"Marie & Pierre",text:"F√©licitations pour votre magnifique union ! Nous vous souhaitons tout le bonheur du monde. üíï",emoji:"üíï",visibility:"public",date:(new Date).toISOString(),timestamp:firebase.firestore.FieldValue.serverTimestamp()},{name:"Nguy·ªÖn Th·ªã Lan",text:"Ch√∫c hai b·∫°n trƒÉm nƒÉm h·∫°nh ph√∫c! M√£i m√£i b√™n nhau nh√©! üéâ",emoji:"ü•Ç",visibility:"anonymous",date:(new Date).toISOString(),timestamp:firebase.firestore.FieldValue.serverTimestamp()},{name:"Jean & Sophie",text:"Un message priv√© juste pour vous : Votre amour est inspirant! Profitez de chaque instant ensemble. ‚ù§Ô∏è",emoji:"üíñ",visibility:"private",date:(new Date).toISOString(),timestamp:firebase.firestore.FieldValue.serverTimestamp()}];for(const t of e)await this.db.collection("guestbook").add(t)}}catch(e){console.error("Error adding demo messages:",e)}}listenForMessages(){this.db.collection("guestbook").where("approved","==",!0).orderBy("timestamp","desc").onSnapshot(e=>{this.displayMessages(e)},e=>{console.error("Error listening to messages:",e)})}async handleSubmit(e){e.preventDefault();const t=document.getElementById("website");if(t&&""!==t.value)return console.log("Spam detected via honeypot"),void this.showNotification("Erreur lors de la soumission","error");const i=document.getElementById("rgpdConsent");if(!i||!i.checked)return void this.showNotification("Veuillez accepter les conditions RGPD / Vui l√≤ng ch·∫•p nh·∫≠n ƒëi·ªÅu kho·∫£n RGPD","error");const s=document.getElementById("guestName").value.trim(),n=document.getElementById("guestMessage").value.trim(),o=document.querySelector('input[name="emoji"]:checked').value,a=document.querySelector('input[name="visibility"]:checked').value;if(!s||!n)return void this.showNotification("Veuillez remplir tous les champs / Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß","error");if(n.length<10)return void this.showNotification("Le message doit contenir au moins 10 caract√®res / Tin nh·∫Øn ph·∫£i c√≥ √≠t nh·∫•t 10 k√Ω t·ª±","error");if((n.match(/https?:\/\//g)||[]).length>2)return void this.showNotification("Trop de liens dans le message / Qu√° nhi·ªÅu li√™n k·∫øt trong tin nh·∫Øn","error");const r={name:s,text:n,emoji:o,visibility:a,date:(new Date).toISOString(),timestamp:firebase.firestore.FieldValue.serverTimestamp(),moderated:!1,approved:!1,userAgent:navigator.userAgent.substring(0,100)};try{await this.db.collection("guestbook").add(r),this.form.reset(),document.querySelector('input[name="emoji"][value="üíï"]').checked=!0,document.querySelector('input[name="visibility"][value="public"]').checked=!0,this.showNotification("Message ajout√© avec succ√®s! / ƒê√£ th√™m tin nh·∫Øn!","success"),setTimeout(()=>{this.messagesContainer.scrollIntoView({behavior:"smooth",block:"nearest"})},500)}catch(e){console.error("Error adding message:",e),this.showNotification("Erreur lors de l'ajout / L·ªói khi th√™m","error")}}displayMessages(e){const t=[];if(e.forEach(e=>{t.push({id:e.id,...e.data()})}),0===t.length)return this.emptyState.style.display="block",this.messagesContainer.style.display="none",void(this.toggleBtn&&(this.toggleBtn.style.display="none"));this.emptyState.style.display="none",this.messagesContainer.style.display="grid",this.toggleBtn&&(this.toggleBtn.style.display="flex"),this.messagesContainer.innerHTML=t.map(e=>{const t=e.visibility||"public",i=this.getVisibilityBadge(t),s="anonymous"===t?"Utilisateur":this.escapeHtml(e.name),n=this.formatDate(e.date);return`\n                <div class="guestbook-message" data-id="${e.id}" data-visibility="${t}">\n                    <div class="message-visibility-badge ${i.class}">\n                        <span>${i.icon}</span>\n                        <span>${i.label}</span>\n                    </div>\n                    <div class="message-header">\n                        <div class="message-avatar">${e.emoji}</div>\n                        <div class="message-info">\n                            <div class="message-name">${s}</div>\n                            <div class="message-date">${n}</div>\n                        </div>\n                    </div>\n                    <div class="message-text">${this.escapeHtml(e.text)}</div>\n                </div>\n            `}).join("");const i=t.filter(e=>"private"!==e.visibility).length,s=t.length,n=this.showPrivate?`${s} message${s>1?"s":""} / tin nh·∫Øn`:`${i} message${i>1?"s":""} / tin nh·∫Øn`;document.querySelector(".guestbook-header p")?.remove();const o=document.querySelector(".guestbook-header");if(o&&!o.querySelector(".message-counter")){const e=document.createElement("p");e.className="message-counter",e.textContent=n,e.style.cssText="font-size: 1.1rem; color: #d4af37; margin-top: 10px;",o.appendChild(e)}}togglePrivateMessages(){this.showPrivate=!this.showPrivate,this.showPrivate?(this.toggleBtn.classList.add("active"),this.toggleBtn.querySelector(".toggle-icon").textContent="üîì",this.toggleBtn.querySelector(".french").textContent="Masquer les messages priv√©s",this.toggleBtn.querySelector(".vietnamese").textContent="·∫®n tin nh·∫Øn ri√™ng t∆∞",document.querySelectorAll('.guestbook-message[data-visibility="private"]').forEach(e=>{e.classList.add("show-private")})):(this.toggleBtn.classList.remove("active"),this.toggleBtn.querySelector(".toggle-icon").textContent="üîí",this.toggleBtn.querySelector(".french").textContent="Afficher les messages priv√©s",this.toggleBtn.querySelector(".vietnamese").textContent="Hi·ªán tin nh·∫Øn ri√™ng t∆∞",document.querySelectorAll('.guestbook-message[data-visibility="private"]').forEach(e=>{e.classList.remove("show-private")}))}getVisibilityBadge(e){const t={public:{icon:"üëÅÔ∏è",label:"Public",class:"badge-public"},anonymous:{icon:"üé≠",label:"Anonyme",class:"badge-anonymous"},private:{icon:"üîí",label:"Priv√©",class:"badge-private"}};return t[e]||t.public}formatDate(e){return e?new Date(e).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}):""}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}showNotification(e,t){const i=document.createElement("div");i.className=`notification notification-${t}`,i.textContent=e,i.style.cssText=`\n            position: fixed;\n            top: 100px;\n            right: 20px;\n            background: ${"success"===t?"linear-gradient(135deg, #46d36f, #2ecc71)":"linear-gradient(135deg, #e74c3c, #c0392b)"};\n            color: white;\n            padding: 15px 25px;\n            border-radius: 10px;\n            box-shadow: 0 5px 20px rgba(0,0,0,0.2);\n            z-index: 10000;\n            font-family: 'Noto Sans', sans-serif;\n            font-weight: 600;\n            animation: slideIn 0.3s ease;\n        `,document.body.appendChild(i),setTimeout(()=>{i.style.animation="slideOut 0.3s ease",setTimeout(()=>i.remove(),300)},3e3)}fallbackToLocalStorage(){console.log("Falling back to localStorage")}}window.addEventListener("load",()=>{setTimeout(()=>{window.db?new FirebaseGuestbook:console.error("Firebase Firestore not available")},1e3)});